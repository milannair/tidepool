name: Clear S3 Bucket

on:
  push:
    branches-ignore:
      - main
      - master
    tags-ignore:
      - '**'  # Never run on tag pushes

jobs:
  clear-bucket:
    runs-on: ubuntu-latest
    
    steps:
      - name: Clear S3 bucket completely
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          BUCKET: ${{ secrets.S3_BUCKET_NAME }}
          ENDPOINT: ${{ secrets.S3_ENDPOINT_URL }}
        run: |
          echo "Clearing bucket: $BUCKET"
          
          # Delete all current objects
          aws s3 rm "s3://$BUCKET" --recursive --endpoint-url "$ENDPOINT" --region us-east-1
          
          # Delete all object versions (if versioning enabled)
          echo "Deleting object versions..."
          aws s3api list-object-versions --bucket "$BUCKET" --endpoint-url "$ENDPOINT" --region us-east-1 \
            --query 'Versions[].{Key:Key,VersionId:VersionId}' --output json 2>/dev/null | \
            jq -r '.[] | "\(.Key) \(.VersionId)"' 2>/dev/null | \
            while read key version; do
              [ -n "$key" ] && aws s3api delete-object --bucket "$BUCKET" --key "$key" --version-id "$version" \
                --endpoint-url "$ENDPOINT" --region us-east-1 2>/dev/null || true
            done
          
          # Delete all delete markers (if versioning enabled)
          echo "Deleting delete markers..."
          aws s3api list-object-versions --bucket "$BUCKET" --endpoint-url "$ENDPOINT" --region us-east-1 \
            --query 'DeleteMarkers[].{Key:Key,VersionId:VersionId}' --output json 2>/dev/null | \
            jq -r '.[] | "\(.Key) \(.VersionId)"' 2>/dev/null | \
            while read key version; do
              [ -n "$key" ] && aws s3api delete-object --bucket "$BUCKET" --key "$key" --version-id "$version" \
                --endpoint-url "$ENDPOINT" --region us-east-1 2>/dev/null || true
            done
          
          # Abort incomplete multipart uploads
          echo "Aborting incomplete multipart uploads..."
          aws s3api list-multipart-uploads --bucket "$BUCKET" --endpoint-url "$ENDPOINT" --region us-east-1 \
            --query 'Uploads[].{Key:Key,UploadId:UploadId}' --output json 2>/dev/null | \
            jq -r '.[] | "\(.Key) \(.UploadId)"' 2>/dev/null | \
            while read key upload_id; do
              [ -n "$key" ] && aws s3api abort-multipart-upload --bucket "$BUCKET" --key "$key" --upload-id "$upload_id" \
                --endpoint-url "$ENDPOINT" --region us-east-1 2>/dev/null || true
            done
          
          echo "Bucket cleared completely"
